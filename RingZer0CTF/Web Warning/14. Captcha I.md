<h1>Captcha I</h1>
<h3>Description</h3>
<label>http://challenges.ringzer0ctf.com:10138/</label>
<h3>Solution</h3>

```python3
import time
import random
import re
import os
import sys
from typing import Optional

from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.common.exceptions import (
    TimeoutException,
    WebDriverException,
    NoSuchElementException,
    UnexpectedAlertPresentException,
    StaleElementReferenceException,
)
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

# Optional helper to auto-download chromedriver. If you don't want it, comment block below and
# create driver = webdriver.Chrome(...) using your chromedriver in PATH.
USE_WEBDRIVER_MANAGER = True

def init_driver(headless=True, page_load_timeout=30, implicitly_wait=3):
    """Initialize and return a Chrome webdriver instance."""
    chrome_options = Options()
    if headless:
        chrome_options.add_argument("--headless=new")  # modern headless
    chrome_options.add_argument("--no-sandbox")
    chrome_options.add_argument("--disable-dev-shm-usage")
    chrome_options.add_argument("--disable-gpu")
    chrome_options.add_argument("--disable-extensions")
    chrome_options.add_argument("--disable-infobars")
    chrome_options.add_argument("--window-size=1200,800")
    chrome_options.add_argument("--ignore-certificate-errors")

    if USE_WEBDRIVER_MANAGER:
        try:
            from webdriver_manager.chrome import ChromeDriverManager
            from selenium.webdriver.chrome.service import Service
            service = Service(ChromeDriverManager().install())
            driver = webdriver.Chrome(service=service, options=chrome_options)
        except Exception as e:
            print("[!] webdriver_manager not available or failed:", e)
            print("[!] Falling back to webdriver.Chrome() - ensure chromedriver is in PATH")
            driver = webdriver.Chrome(options=chrome_options)
    else:
        driver = webdriver.Chrome(options=chrome_options)

    driver.set_page_load_timeout(page_load_timeout)
    driver.implicitly_wait(implicitly_wait)
    return driver

# ---------------- Config ----------------
URL_FORM = "http://challenges.ringzer0ctf.com:10138/form1.php"
URL_ACTION = "http://challenges.ringzer0ctf.com:10138/captcha1.php"  # not used directly by selenium
PROGRESS_FILE = "progress.txt"
LOG_DIR = "responses"
HEADLESS = True
MAX_TOTAL = 1100  # how many attempts total (adjust)
MAX_DRIVER_RESTARTS = 5
# ----------------------------------------

os.makedirs(LOG_DIR, exist_ok=True)

def load_progress() -> int:
    if os.path.exists(PROGRESS_FILE):
        try:
            with open(PROGRESS_FILE, "r") as f:
                return int(f.read().strip() or "0")
        except:
            return 0
    return 0

def save_progress(n: int):
    with open(PROGRESS_FILE, "w") as f:
        f.write(str(n))

def save_response_html(i: int, html: str):
    fname = os.path.join(LOG_DIR, f"response_{i}.html")
    with open(fname, "w", encoding="utf-8") as f:
        f.write(html)

def main():
    start_idx = load_progress()
    print(f"[+] Resuming from {start_idx} (progress file: '{PROGRESS_FILE}')")

    driver = init_driver(headless=HEADLESS)
    driver_restart_count = 0
    i = start_idx

    while i < MAX_TOTAL:
        i += 1
        try:
            # small random delay to look less bot-like
            time.sleep(random.uniform(0.3, 1.0))

            # Try to GET the form page, with retries on network timeouts
            got = False
            for attempt in range(3):
                try:
                    driver.get(URL_FORM)
                    got = True
                    break
                except (TimeoutException, WebDriverException) as e:
                    print(f"[{i}] ⚠️ GET attempt {attempt+1} failed: {e}")
                    time.sleep(1 + attempt * 2)

            if not got:
                raise TimeoutException("Failed to load form after retries")

            # Wait for the captcha image or input to appear
            try:
                WebDriverWait(driver, 5).until(
                    EC.presence_of_element_located((By.ID, "captcha-form"))
                )
            except TimeoutException:
                # proceed anyway: maybe JS hasn't created element, but page_source might still include script
                pass

            page_source = driver.page_source

            # Extract answer from the script: if (A == "....")
            m = re.search(r'if\s*\(A\s*==\s*"([^"]+)"\)', page_source)
            if not m:
                print(f"[{i}] [!] Could not parse answer from page. Saving HTML for inspection.")
                save_response_html(i, page_source)
                # continue to next iteration (or try a couple times)
                # small delay and continue
                time.sleep(1)
                continue

            answer = m.group(1)
            print(f"[{i}] Found answer -> {answer}")

            # Fill the input
            try:
                inp = driver.find_element(By.ID, "captcha-form")
                inp.clear()
                inp.send_keys(answer)
            except NoSuchElementException:
                print(f"[{i}] [!] Input element not found visually; saving HTML and continuing.")
                save_response_html(i, page_source)
                continue

            # Click the send button
            try:
                btn = driver.find_element(By.XPATH, '//input[@type="button"]')
                btn.click()
            except (NoSuchElementException, StaleElementReferenceException) as e:
                print(f"[{i}] [!] Button click problem: {e}. Trying JS submit fallback.")
                try:
                    driver.execute_script("document.forms['Form1'].submit();")
                except Exception as e2:
                    print(f"[{i}] [!] Fallback submit also failed: {e2}")
                    save_response_html(i, driver.page_source)
                    continue

            # After submit, small wait for result to load
            time.sleep(random.uniform(0.3, 1.2))

            # Handle potential JS alert (BAD Captcha)
            try:
                alert = driver.switch_to.alert
                # If there's an alert, accept it and consider this attempt failed
                alert_text = alert.text
                print(f"[{i}] [!] JS Alert present: {alert_text}. Accepting and continuing.")
                alert.accept()
                save_response_html(i, driver.page_source)
                continue
            except Exception:
                # no alert
                pass

            result_page = driver.page_source
            save_response_html(i, result_page)

            if "You now have" in result_page:
                # success
                if MAX_TOTAL in range(950,1050):
                    print(result_page)
                print(f"[{i}] ✅ Sukses - {answer}")
            else:
                # Not success — maybe server returned minimal/newline-only page
                # Print short excerpt for debugging
                excerpt = "\n".join(line for line in result_page.splitlines()[:10])
                excerpt = excerpt.strip() or "<empty or newlines only>"
                print(f"[{i}] ⚠️ Response did not contain success phrase. Excerpt:\n{excerpt}")

            # update progress file
            save_progress(i)

        except (TimeoutException, WebDriverException) as e:
            print(f"[{i}] ⚠️ Network/Driver error: {repr(e)}. Will restart driver and continue.")
            driver_restart_count += 1
            try:
                driver.quit()
            except:
                pass
            # restart driver if we haven't exceeded limit
            if driver_restart_count > MAX_DRIVER_RESTARTS:
                print("[!] Too many driver restarts. Exiting.")
                break
            time.sleep(2 + random.random()*2)
            try:
                driver = init_driver(headless=HEADLESS)
            except Exception as e2:
                print("[!] Failed to restart driver:", e2)
                time.sleep(3)
                continue
            continue

        except UnexpectedAlertPresentException as e:
            # If unexpected alert surfaced somewhere else
            try:
                alert = driver.switch_to.alert
                print(f"[{i}] Unexpected alert: {alert.text} — accepting and continuing.")
                alert.accept()
            except Exception:
                pass
            continue

        except Exception as e:
            print(f"[{i}] ❌ Unhandled exception: {repr(e)} — saving page and continuing.")
            try:
                save_response_html(i, driver.page_source)
            except Exception:
                pass
            # keep going
            continue

    print("[+] Done. Final progress:", i)
    try:
        driver.quit()
    except:
        pass

if __name__ == "__main__":
    main()

```
<h3>Flag</h3>
<pre>
9bc635d4385e8a1775ad98980f44eb7d1714f69b
</pre>
